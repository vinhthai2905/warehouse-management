{% extends 'main.html' %}
{% load static %}

{% block link %}
    <link rel="stylesheet" href="{% static 'css/sale_staff/export-request.css' %}">
{% endblock %}

{% block main-content %}

    {% if messages %}
        <div class="notify-box">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="export-manager">

        <div class="status-tabs">
            <span class="status-tab active" data-target="all">Tất cả</span>
            <span class="status-tab" data-target="pending">Chưa duyệt</span>
            <span class="status-tab" data-target="approved">Đã duyệt</span>
            <span class="status-tab" data-target="exported">Đã xuất</span>
        </div>


        <div id="all" class="status-panel">
            <table class="req-table">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>Mã yêu cầu</th>
                    <th>Thời gian yêu cầu</th>
                    <th>Nhân viên yêu cầu</th>
                    <th>Trạng thái</th>
                    <th>Chi tiết yêu cầu</th>
                </tr>
                </thead>
                <tbody>
                {% for e in export_request_dict %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ e.id }}</td>
                        <td>{{ e.date|date:'H:i d/m/Y' }}</td>
                        <td>{{ e.request_employee }}</td>
                        <td>
                    <span class="status
                        {% if e.status == 'Chờ duyệt' %}pending
                        {% elif e.status == 'Đã duyệt' %}approved
                        {% elif e.status == 'Đã xuất' %}exported
                        {% endif %}">
                        {{ e.status }}
                    </span>
                        </td>
                        <td>
                            <a href="{% url 'export-detail' %}?request_id={{ e.id }}" class="detail-link">
                                Xem chi tiết
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="pending" class="status-panel hidden">
            <table class="req-table">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>Mã yêu cầu</th>
                    <th>Thời gian yêu cầu</th>
                    <th>Nhân viên yêu cầu</th>
                    <th>Trạng thái</th>
                    <th>Chi tiết yêu cầu</th>
                </tr>
                </thead>
                <tbody>
                {% for e in export_request_dict %}
                    {% if e.status == 'Chờ duyệt' %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ e.id }}</td>
                            <td>{{ e.date|date:'H:i d/m/Y' }}</td>
                            <td>{{ e.request_employee }}</td>
                            <td><span class="status pending">Chưa duyệt</span></td>
                            <td><a href="{% url 'export-detail' %}?request_id={{ e.id }}" class="detail-link">Xem chi
                                tiết</a></td>
                        </tr>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="approved" class="status-panel hidden">
            <table class="req-table">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>Mã yêu cầu</th>
                    <th>Thời gian yêu cầu</th>
                    <th>Nhân viên yêu cầu</th>
                    <th>Trạng thái</th>
                    <th>Chi tiết yêu cầu</th>
                </tr>
                </thead>
                <tbody>
                {% for e in export_request_dict %}
                    {% if e.status == 'Đã duyệt' %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ e.id }}</td>
                            <td>{{ e.date|date:'H:i d/m/Y' }}</td>
                            <td>{{ e.request_employee }}</td>
                            <td><span class="status approved">Đã duyệt</span></td>
                            <td><a href="{% url 'export-detail' %}?request_id={{ e.id }}" class="detail-link">Xem chi
                                tiết</a></td>
                        </tr>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="exported" class="status-panel hidden">
            <table class="req-table">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>Mã yêu cầu</th>
                    <th>Thời gian yêu cầu</th>
                    <th>Nhân viên yêu cầu</th>
                    <th>Trạng thái</th>
                    <th>Chi tiết yêu cầu</th>
                </tr>
                </thead>
                <tbody>
                {% for e in export_request_dict %}
                    {% if e.status == 'Đã xuất' %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ e.id }}</td>
                            <td>{{ e.date|date:'H:i d/m/Y' }}</td>
                            <td>{{ e.request_employee }}</td>
                            <td><span class="status exported">Đã xuất</span></td>
                            <td><a href="{% url 'export-detail' %}?request_id={{ e.id }}" class="detail-link">Xem chi
                                tiết</a></td>
                        </tr>
                    {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

    <script>
        document.querySelectorAll('.status-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.status-panel').forEach(p => p.classList.add('hidden'));
                const targetPanel = document.getElementById(tab.dataset.target);
                targetPanel.classList.remove('hidden');

                const rows = targetPanel.querySelectorAll('tbody tr');
                const table = targetPanel.querySelector('table.req-table');
                const note = targetPanel.querySelector('p.empty-note');

                if (rows.length === 0) {
                    if (table) table.style.display = 'none';
                    if (note) note.style.display = 'block';
                } else {
                    if (table) table.style.display = 'table';
                    if (note) note.style.display = 'none';
                }
            });
        });

        window.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.status-tab.active')?.click();
        });
    </script>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const alertBox = document.querySelector('.notify-box .alert');
            if (alertBox) {
                setTimeout(() => {
                    alertBox.style.opacity = '0';
                    alertBox.style.transition = 'opacity 0.6s ease';
                    setTimeout(() => alertBox.remove(), 600);
                }, 3000);
            }
        });
    </script>

{% endblock %}
