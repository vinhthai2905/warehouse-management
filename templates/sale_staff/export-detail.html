{% extends 'main.html' %}
{% load static %}

{% block link %}
    <link rel="stylesheet" href="{% static 'css/sale_staff/export-detail.css' %}">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css'>
{% endblock link %}

{% block main-content %}
    <h2 id="title">Chi tiết yêu cầu xuất hàng bán</h2>

    <div id="export-receipt">
        <section>
            <dl id="export-detail">
                <dt>Thời gian yêu cầu: {{ export_info.request_date }}</dt>
                <dt>Thời gian duyệt: {{ export_info.review_date }}</dt>
                <dt>Thời gian xuất: {{ export_info.export_date }}</dt>
                <dt>Nhân viên yêu cầu: {{ export_info.request_employee }}</dt>
                <dt>Nhân viên xuất hàng: {{ export_info.export_employee }}</dt>
                <dt>Trạng thái: {{ export_info.status }}</dt>
            </dl>
        </section>

        <section>
            <form id="real-quantity-form" method="post"
                  action="{% url 'resend-export-request' %}?request_id={{ request.GET.request_id }}">
                {% csrf_token %}
                <input type="hidden" name="request_id" value="{{ request.GET.request_id }}">
                <table id="table-content">
                    <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên mặt hàng</th>
                        <th>Số lượng</th>
                        <th>Số lượng thực</th>
                        <th>Ghi chú</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for product in export_product_dict %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ product.name }}</td>
                            <td class="quantity">{{ product.quantity }}</td>
                            <td>
                                {% if export_info.status != 'Đã xuất' %}
                                    <input type="number" class="real-quantity" name="real_quantity"
                                           value="{{ product.real_quantity }}" min="0"/>
                                {% else %}
                                    <span class="real-quantity">{{ product.real_quantity }}</span>
                                {% endif %}
                            </td>
                            <td>{{ product.note }}</td>
                        </tr>

                    {% endfor %}
                    </tbody>
                </table>
            </form>
        </section>
    </div>

    <section>
        <div id="button-row">
            <form action="{% url 'export-request' %}" method="get">
                <button id="previous-button" type="submit">Quay lại</button>
            </form>
            {% if export_info.status != 'Đã xuất' %}
                <form action="{% url 'export-confirm' %}" method="post"
                      onsubmit="return confirm('Bạn có chắc chắn muốn xác nhận đã nhận đủ?');">
                    {% csrf_token %}
                    <input type="hidden" name="request_id" value="{{ request.GET.request_id }}">
                    <input type="hidden" id="confirmed_at" name="confirmed_at">
                    <input type="hidden" id="export_employee" name="export_employee"
                           value="{{ request.session.user_id }}">
                    <button id="confirmation-button" type="submit">Xác nhận đã nhận đủ</button>
                </form>

                <button id="resend-request-button" type="submit" form="real-quantity-form">
                    Gửi lại yêu cầu
                </button>
            {% else %}

                <button id="confirmation-button" disabled style="cursor: not-allowed; opacity: 0.5;">
                    Đã xác nhận
                </button>
            {% endif %}
        </div>
    </section>

    <script>
        function confirmProceed() {
            const proceed = confirm('Bạn có chắc chắn muốn xác nhận đã nhận đủ?');
            if (proceed) {
                const now = new Date().toISOString();
                document.getElementById('confirmed_at').value = now;
                return true; // allow form submit
            } else {
                console.log('User cancelled confirmation.');
                return false; // prevent form submit
            }
        }
    </script>

    <script>
        function checkMismatch() {
            const quantities = document.querySelectorAll('.quantity');
            const realQuantities = document.querySelectorAll('.real-quantity');
            const resendButton = document.getElementById('resend-request-button');

            if (!resendButton) return;

            let mismatch = false;

            for (let i = 0; i < quantities.length; i++) {
                const expected = parseInt(quantities[i].innerText);
                const actual = parseInt(realQuantities[i].value);

                if (expected !== actual) {
                    mismatch = true;
                    break;
                }
            }

            resendButton.disabled = !mismatch;
            resendButton.style.cursor = mismatch ? 'pointer' : 'not-allowed';
            resendButton.style.opacity = mismatch ? '1' : '0.5';
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkMismatch();  // Run once when page loads

            // Dynamically re-check on every input change
            document.querySelectorAll('.real-quantity').forEach(input => {
                input.addEventListener('input', checkMismatch);
            });
        });
    </script>

{% endblock main-content %}